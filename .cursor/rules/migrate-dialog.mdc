---
description: Migrate a dialog component from the legacy imperative ref-based Dialog system to the new hook-based NiceModal dialog system (FormDialog or CentralizedDialog). This rule focuses only on the migration â€” testing is handled separately.
globs:
  - 'src/**/*.tsx'
  - 'src/**/*.ts'
---

# Dialog Migration Guide

This guide helps migrate dialog components from the legacy imperative ref-based system (`forwardRef` + `useImperativeHandle` + `Dialog` from design system) to the new hook-based NiceModal system (`useFormDialog` / `useCentralizedDialog`).

> **Note:** This guide only handles the migration of the dialog and its parent component(s). Tests should be updated separately using a dedicated testing skill.

## Prerequisites

Before starting, gather context by reading these reference files:

### New Dialog System

1. **FormDialog**: `src/components/dialogs/FormDialog.tsx` - Dialog with form support
2. **CentralizedDialog**: `src/components/dialogs/CentralizedDialog.tsx` - Simple action/confirmation dialog
3. **BaseDialog**: `src/components/dialogs/BaseDialog.tsx` - Underlying dialog component
4. **Dialog Types**: `src/components/dialogs/types.ts` - `DialogResult`, `HookDialogReturnType`, `FormProps`
5. **Dialog Constants**: `src/components/dialogs/const.ts` - Dialog names and test IDs
6. **Registered Dialogs**: `src/core/dialogs/registeredDialogs.ts` - NiceModal registration

### Migration Examples

7. **FormDialog Example**: `src/pages/settings/teamAndSecurity/members/dialogs/CreateInviteDialog.tsx` - Hook-based FormDialog
8. **FormDialog Example 2**: `src/pages/settings/teamAndSecurity/members/dialogs/EditInviteRoleDialog.tsx` - Hook-based FormDialog (simpler)
9. **CentralizedDialog Example**: `src/pages/settings/teamAndSecurity/members/dialogs/RevokeInviteDialog.tsx` - Hook-based CentralizedDialog
10. **CentralizedDialog Example 2**: `src/pages/settings/teamAndSecurity/members/dialogs/RevokeMembershipDialog.tsx` - CentralizedDialog with conditional behavior

---

## Migration Steps

### Phase 1: Pre-Migration Analysis

#### Step 1.1: Analyze the Current Dialog

1. Read the target dialog file completely
2. Identify:
   - Whether it's a **form dialog** (has form fields + submit) or a **simple dialog** (just actions/display)
   - The imperative ref interface (`openDialog`, `closeDialog`)
   - Internal state managed via `useState` (typically `localData`)
   - Form setup (if any): `useAppForm`, validation schema, `onSubmit` handler
   - What data is passed via `openDialog(data)`
   - The dialog's JSX content (children)
   - The dialog's actions (submit button, cancel button)

#### Step 1.2: Determine Target Dialog Type

| Old Dialog Pattern                             | New Dialog Type                                     | When to Use                                             |
| ---------------------------------------------- | --------------------------------------------------- | ------------------------------------------------------- |
| Has form fields + submit button                | `useFormDialog`                                     | Dialog contains a form with validation                  |
| Has a single action button (confirm/copy/etc.) | `useCentralizedDialog`                              | Dialog is for confirmation or simple action             |
| Uses `useCentralizedDialog`                    | Confirmation/warning dialogs with danger/info modes |
| Chains to another dialog after success         | Both                                                | Use FormDialog for the form, chain to CentralizedDialog |

#### Step 1.3: Find All Usages

Search for all places where the dialog is used:

```bash
grep -r "DialogName\|DialogNameRef" src/ --include="*.tsx" --include="*.ts"
```

Identify:

- Parent components that create refs and render the dialog
- How `openDialog` is called and what data is passed
- Any props passed to the dialog component (these need to be moved to the open function data or computed in the parent)

---

### Phase 2: Implementation

#### Step 2.1: Rewrite the Dialog as a Custom Hook

**Old Pattern (imperative ref-based):**

```typescript
export interface MyDialogRef {
  openDialog: (data: MyDialogData) => unknown
  closeDialog: () => unknown
}

export const MyDialog = forwardRef<MyDialogRef>((_, ref) => {
  const dialogRef = useRef<DialogRef>(null)
  const [localData, setLocalData] = useState<MyDialogData | null>(null)

  useImperativeHandle(ref, () => ({
    openDialog: (data) => {
      setLocalData(data)
      dialogRef.current?.openDialog()
    },
    closeDialog: () => dialogRef.current?.closeDialog(),
  }))

  return (
    <Dialog ref={dialogRef} title={...} actions={...} formId={...} formSubmit={...}>
      {/* content using localData */}
    </Dialog>
  )
})
```

**New Pattern (hook-based with FormDialog):**

```typescript
export const useMyDialog = () => {
  const formDialog = useFormDialog()
  const { translate } = useInternationalization()
  // ... other hooks (mutations, etc.)
  const dataRef = useRef<MyData | null>(null)
  const successRef = useRef(false)

  const form = useAppForm({
    defaultValues: initialValues,
    validationLogic: revalidateLogic(),
    validators: { onDynamic: validationSchema },
    onSubmit: async ({ value }) => {
      const result = await myMutation({
        variables: { input: { ...value, id: dataRef.current?.id as string } },
      })

      if (result.data?.myMutation) {
        successRef.current = true
      }
    },
  })

  const handleSubmit = async (): Promise<DialogResult> => {
    successRef.current = false
    await form.handleSubmit()

    if (!successRef.current) {
      throw new Error('Submit failed')
    }

    return { reason: 'success' }
  }

  const openMyDialog = (data: MyData) => {
    dataRef.current = data
    form.reset()
    // Set form values from data if editing
    form.setFieldValue('fieldName', data.fieldValue || '')

    formDialog
      .open({
        title: translate('...'),
        children: (
          <div className="...">
            {/* Dialog content */}
          </div>
        ),
        closeOnError: false,
        mainAction: (
          <form.AppForm>
            <form.SubmitButton>{translate('...')}</form.SubmitButton>
          </form.AppForm>
        ),
        form: {
          id: MY_FORM_ID,
          submit: handleSubmit,
        },
      })
      .then((response) => {
        if (response.reason === 'close') {
          form.reset()
          dataRef.current = null
        }
      })
  }

  return { openMyDialog }
}
```

**New Pattern (hook-based with CentralizedDialog):**

```typescript
export const useMyDialog = () => {
  const centralizedDialog = useCentralizedDialog()
  const { translate } = useInternationalization()

  const openMyDialog = (data: MyData) => {
    centralizedDialog.open({
      title: translate('...'),
      description: translate('...'),
      actionText: translate('...'),
      colorVariant: 'danger', // or 'info'
      onAction: async () => {
        // Perform action (e.g., mutation, copy to clipboard)
        await myMutation({ variables: { input: { id: data.id } } })
      },
    })
  }

  return { openMyDialog }
}
```

#### Step 2.2: Key Migration Decisions

**Handling `localData` state:**

- Old: `useState` to store data passed via `openDialog`
- New: Use a `useRef` to store data passed to the hook's open function. The ref is captured in closures for `onSubmit` and `children`.

**Handling form initial values when editing:**

- Old: `initialValues` depended on `localData` state, re-rendered on state change
- New: Call `form.reset()` then `form.setFieldValue(...)` before opening the dialog. The form values are set synchronously before `formDialog.open()` is called.

**Handling form submission:**

- Old: `handleSubmit` called `e.preventDefault()` + `form.handleSubmit()`; dialog closed by calling `dialogRef.current?.closeDialog()` inside `onSubmit`
- New: `handleSubmit` returns a `Promise<DialogResult>`. Use a `successRef` to track whether the mutation succeeded. The dialog auto-closes on success (when the promise resolves). Throw an error to keep the dialog open on failure.

**Handling dialog close/cleanup:**

- Old: `onClose` callback reset the form
- New: Use `.then()` on the promise returned by `formDialog.open()`. Check `response.reason === 'close'` to reset form and clear refs.

**Handling component props (like `admins` list):**

- Old: Props passed to the dialog component `<MyDialog admins={admins} />`
- New: Compute derived values (like `isDeletingLastAdmin`) in the parent and pass them as part of the open function data.

#### Step 2.3: Update Imports in the Dialog File

Remove:

```typescript
import { forwardRef, useImperativeHandle, useRef, useState } from 'react'
import { Button } from '~/components/designSystem/Button'
import { Dialog, DialogRef } from '~/components/designSystem/Dialog'
import { WarningDialog } from '~/components/designSystem/WarningDialog'
```

Add (for FormDialog):

```typescript
import { useRef } from 'react'
import { useFormDialog } from '~/components/dialogs/FormDialog'
import { DialogResult } from '~/components/dialogs/types'
```

Or (for CentralizedDialog):

```typescript
import { useCentralizedDialog } from '~/components/dialogs/CentralizedDialog'
```

#### Step 2.4: Remove Old Exports

Remove:

```typescript
export interface MyDialogRef {
  openDialog: (data: ...) => unknown
  closeDialog: () => unknown
}
export const MyDialog = forwardRef<MyDialogRef>(...)
MyDialog.displayName = 'forwardRef'
```

Replace with:

```typescript
export const useMyDialog = () => { ... }
```

#### Step 2.5: Update Parent Components

**Old usage:**

```typescript
import { MyDialog, MyDialogRef } from './dialogs/MyDialog'

const parentComponent = () => {
  const myDialogRef = useRef<MyDialogRef>(null)

  const handleAction = () => {
    myDialogRef.current?.openDialog({ /* data */ })
  }

  return (
    <>
      {/* ... */}
      <MyDialog ref={myDialogRef} />
    </>
  )
}
```

**New usage:**

```typescript
import { useMyDialog } from './dialogs/MyDialog'

const parentComponent = () => {
  const { openMyDialog } = useMyDialog()

  const handleAction = () => {
    openMyDialog(/* data */)
  }

  return (
    <>
      {/* ... */}
      {/* No need to render MyDialog in JSX anymore */}
    </>
  )
}
```

Key changes in parent:

1. Remove `useRef<MyDialogRef>` import and usage
2. Import the new hook instead of the component + ref type
3. Call the hook's open function directly (no `.current?.openDialog()`)
4. Remove `<MyDialog ref={...} />` from JSX (the dialog is now rendered via NiceModal)
5. Clean up `useRef` import from React if no longer needed

---

### Phase 3: Verification

#### Step 3.1: Type Check

```bash
npx tsc --noEmit
```

#### Step 3.2: Lint

```bash
pnpm lint
```

Ensure there are no TypeScript errors or lint violations before considering the migration complete.

---

## Dialog Type Reference

### DialogResult (discriminated union)

```typescript
type DialogResult =
  | { reason: 'close' }
  | { reason: 'open-other-dialog'; otherDialog: Promise<DialogResult> }
  | { reason: 'success'; params?: unknown }
  | { reason: 'error'; error: Error }
```

### FormDialogProps

```typescript
type FormDialogProps = {
  title: ReactNode
  description?: ReactNode
  headerContent?: ReactNode
  children?: ReactNode
  mainAction?: ReactNode
  cancelOrCloseText?: 'close' | 'cancel'
  closeOnError?: boolean
  onError?: (error: Error) => void
  form: FormProps  // { id: string; submit: (e: React.FormEvent) => void }
}
```

### CentralizedDialogProps

```typescript
type CentralizedDialogProps = {
  title: ReactNode
  description?: ReactNode
  headerContent?: ReactNode
  children?: ReactNode
  onAction: () => DialogResult | Promise<DialogResult> | void | Promise<void>
  actionText: string
  colorVariant?: 'info' | 'danger'
  disableOnContinue?: boolean
  cancelOrCloseText?: 'close' | 'cancel'
  closeOnError?: boolean
  onError?: (error: Error) => void
}
```

---

## Complete Before/After Example: FormDialog (EditInviteRoleDialog)

### BEFORE (Imperative Ref-Based)

```typescript
import Stack from '@mui/material/Stack'
import { revalidateLogic } from '@tanstack/react-form'
import { forwardRef, useImperativeHandle, useRef, useState } from 'react'
import { z } from 'zod'

import { Avatar } from '~/components/designSystem/Avatar'
import { Button } from '~/components/designSystem/Button'
import { Dialog, DialogRef } from '~/components/designSystem/Dialog'
import { Typography } from '~/components/designSystem/Typography'
import { InviteForEditRoleForDialogFragment } from '~/generated/graphql'
import { useInternationalization } from '~/hooks/core/useInternationalization'
import { useAppForm } from '~/hooks/forms/useAppform'

import RolePicker from './RolePicker'
import { UpdateInviteSingleRole } from '../common/inviteTypes'
import { useInviteActions } from '../hooks/useInviteActions'

export const EDIT_INVITE_ROLE_FORM_ID = 'form-edit-invite-role'
export interface EditInviteRoleDialogRef {
  openDialog: (localData: { invite: InviteForEditRoleForDialogFragment | null }) => unknown
  closeDialog: () => unknown
}

export const EditInviteRoleDialog = forwardRef<EditInviteRoleDialogRef>((_, ref) => {
  const { translate } = useInternationalization()
  const { updateInviteRole } = useInviteActions()
  const dialogRef = useRef<DialogRef>(null)
  const [localData, setLocalData] = useState<{ invite: InviteForEditRoleForDialogFragment | null } | null>(null)

  const validationSchema = z.object({ role: z.string() })
  const initialValues: UpdateInviteSingleRole = { role: localData?.invite?.roles[0] || '' }

  const form = useAppForm({
    defaultValues: initialValues,
    validationLogic: revalidateLogic(),
    validators: { onDynamic: validationSchema },
    onSubmit: async ({ value }) => {
      await updateInviteRole({
        variables: { input: { roles: [value.role], id: localData?.invite?.id as string } },
      })
      setLocalData(null)
      dialogRef.current?.closeDialog()
    },
  })

  useImperativeHandle(ref, () => ({
    openDialog: (data) => { setLocalData(data); dialogRef.current?.openDialog() },
    closeDialog: () => { dialogRef.current?.closeDialog() },
  }))

  const handleClose = () => { form.reset() }
  const handleSubmit = (e: React.FormEvent) => { e.preventDefault(); form.handleSubmit() }
  const getActions = ({ closeDialog }: { closeDialog: () => void }) => (
    <>
      <Button variant="quaternary" onClick={closeDialog}>{translate('text_62bb10ad2a10bd182d002031')}</Button>
      <form.AppForm><form.SubmitButton>{translate('text_664f035a68227f00e261b7f6')}</form.SubmitButton></form.AppForm>
    </>
  )

  return (
    <Dialog ref={dialogRef} title={translate('text_664f035a68227f00e261b7e9')} onClose={handleClose} actions={getActions} formId={EDIT_INVITE_ROLE_FORM_ID} formSubmit={handleSubmit}>
      <div className="mb-8 flex flex-col gap-8">
        <Stack gap={3} direction="row" alignItems="center">
          <Avatar variant="user" identifier={(localData?.invite?.email || '').charAt(0)} size="big" />
          <Typography variant="body" color="grey700">{localData?.invite?.email}</Typography>
        </Stack>
        <RolePicker form={form} fields={{ role: 'role' }} />
      </div>
    </Dialog>
  )
})

EditInviteRoleDialog.displayName = 'forwardRef'
```

### AFTER (Hook-Based NiceModal)

```typescript
import Stack from '@mui/material/Stack'
import { revalidateLogic } from '@tanstack/react-form'
import { useRef } from 'react'
import { z } from 'zod'

import { Avatar } from '~/components/designSystem/Avatar'
import { Typography } from '~/components/designSystem/Typography'
import { useFormDialog } from '~/components/dialogs/FormDialog'
import { DialogResult } from '~/components/dialogs/types'
import { InviteForEditRoleForDialogFragment } from '~/generated/graphql'
import { useInternationalization } from '~/hooks/core/useInternationalization'
import { useAppForm } from '~/hooks/forms/useAppform'

import RolePicker from './RolePicker'
import { UpdateInviteSingleRole } from '../common/inviteTypes'
import { useInviteActions } from '../hooks/useInviteActions'

export const EDIT_INVITE_ROLE_FORM_ID = 'form-edit-invite-role'

const initialValues: UpdateInviteSingleRole = { role: '' }
const validationSchema = z.object({ role: z.string() })

export const useEditInviteRoleDialog = () => {
  const formDialog = useFormDialog()
  const { translate } = useInternationalization()
  const { updateInviteRole } = useInviteActions()
  const inviteRef = useRef<InviteForEditRoleForDialogFragment | null>(null)
  const successRef = useRef(false)

  const form = useAppForm({
    defaultValues: initialValues,
    validationLogic: revalidateLogic(),
    validators: { onDynamic: validationSchema },
    onSubmit: async ({ value }) => {
      const result = await updateInviteRole({
        variables: { input: { roles: [value.role], id: inviteRef.current?.id as string } },
      })
      if (result.data?.updateInvite) { successRef.current = true }
    },
  })

  const handleSubmit = async (): Promise<DialogResult> => {
    successRef.current = false
    await form.handleSubmit()
    if (!successRef.current) throw new Error('Submit failed')
    return { reason: 'success' }
  }

  const openEditInviteRoleDialog = (invite: InviteForEditRoleForDialogFragment) => {
    inviteRef.current = invite
    form.reset()
    form.setFieldValue('role', invite.roles[0] || '')

    formDialog
      .open({
        title: translate('text_664f035a68227f00e261b7e9'),
        children: (
          <div className="flex flex-col gap-8 p-8">
            <Stack gap={3} direction="row" alignItems="center">
              <Avatar variant="user" identifier={(invite.email || '').charAt(0)} size="big" />
              <Typography variant="body" color="grey700">{invite.email}</Typography>
            </Stack>
            <RolePicker form={form} fields={{ role: 'role' }} />
          </div>
        ),
        closeOnError: false,
        mainAction: (
          <form.AppForm>
            <form.SubmitButton>{translate('text_664f035a68227f00e261b7f6')}</form.SubmitButton>
          </form.AppForm>
        ),
        form: { id: EDIT_INVITE_ROLE_FORM_ID, submit: handleSubmit },
      })
      .then((response) => {
        if (response.reason === 'close') { form.reset(); inviteRef.current = null }
      })
  }

  return { openEditInviteRoleDialog }
}
```

---

## Complete Before/After Example: CentralizedDialog (RevokeInviteDialog)

### BEFORE

```typescript
import { forwardRef, useImperativeHandle, useRef, useState } from 'react'
import { DialogRef } from '~/components/designSystem/Dialog'
import { WarningDialog } from '~/components/designSystem/WarningDialog'
import { useInternationalization } from '~/hooks/core/useInternationalization'
import { useInviteActions } from '../hooks/useInviteActions'

export interface RevokeInviteDialogRef {
  openDialog: (infos: { id: string; email: string; organizationName: string }) => unknown
  closeDialog: () => unknown
}

export const RevokeInviteDialog = forwardRef<RevokeInviteDialogRef>((_, ref) => {
  const dialogRef = useRef<DialogRef>(null)
  const { translate } = useInternationalization()
  const { revokeInvite } = useInviteActions()
  const [localData, setLocalData] = useState<{ id: string; email: string; organizationName: string } | undefined>()

  useImperativeHandle(ref, () => ({
    openDialog: (infos) => { setLocalData(infos); dialogRef.current?.openDialog() },
    closeDialog: () => dialogRef.current?.closeDialog(),
  }))

  return (
    <WarningDialog
      ref={dialogRef}
      title={translate('text_63208c701ce25db781407430')}
      description={translate('text_63208c701ce25db78140743c', { memberEmail: localData?.email, organizationName: localData?.organizationName })}
      onContinue={async () => { await revokeInvite({ variables: { input: { id: localData?.id as string } } }) }}
      continueText={translate('text_63208c701ce25db78140745e')}
    />
  )
})
```

### AFTER

```typescript
import { Typography } from '~/components/designSystem/Typography'
import { useCentralizedDialog } from '~/components/dialogs/CentralizedDialog'
import { useInternationalization } from '~/hooks/core/useInternationalization'
import { useInviteActions } from '../hooks/useInviteActions'

type RevokeInviteInfos = { id: string; email: string; organizationName: string }

export const useRevokeInviteDialog = () => {
  const centralizedDialog = useCentralizedDialog()
  const { translate } = useInternationalization()
  const { revokeInvite } = useInviteActions()

  const openRevokeInviteDialog = (inviteInfos: RevokeInviteInfos) => {
    centralizedDialog.open({
      title: translate('text_63208c701ce25db781407430'),
      description: (
        <Typography>
          {translate('text_63208c701ce25db78140743c', {
            memberEmail: inviteInfos.email,
            organizationName: inviteInfos.organizationName,
          })}
        </Typography>
      ),
      colorVariant: 'danger',
      actionText: translate('text_63208c701ce25db78140745e'),
      onAction: async () => {
        await revokeInvite({ variables: { input: { id: inviteInfos.id } } })
      },
    })
  }

  return { openRevokeInviteDialog }
}
```

---

## Key Differences Summary

| Aspect           | Old (Imperative Ref)                          | New (Hook-Based NiceModal)                             |
| ---------------- | --------------------------------------------- | ------------------------------------------------------ |
| Component type   | `forwardRef` component                        | Custom hook (`useMyDialog`)                            |
| Opening dialog   | `ref.current?.openDialog(data)`               | `openMyDialog(data)`                                   |
| Data storage     | `useState(localData)`                         | `useRef(data)`                                         |
| Dialog rendering | `<Dialog ref={dialogRef}>` in JSX             | `formDialog.open({ children })`                        |
| Form submission  | `handleSubmit(e)` calls `e.preventDefault()`  | `handleSubmit()` returns `Promise<DialogResult>`       |
| Closing dialog   | `dialogRef.current?.closeDialog()`            | Auto-closes on success; `.then()` for cleanup          |
| Actions          | `getActions({ closeDialog })` render function | `mainAction` prop (just the submit button)             |
| Cancel button    | Manually rendered in `actions`                | Automatically rendered by FormDialog/CentralizedDialog |
| Parent usage     | `useRef` + render `<Dialog>` in JSX           | `useHook()` + call open function                       |
| Parent cleanup   | Remove `<Dialog>` from JSX                    | Nothing to render                                      |

---

## Checklist

### Phase 1: Analysis

- [ ] Read the target dialog file completely
- [ ] Determine dialog type (FormDialog vs CentralizedDialog)
- [ ] Find all usages of the dialog (parent components)
- [ ] Identify data passed via `openDialog`
- [ ] Identify any props passed to the dialog component

### Phase 2: Implementation

- [ ] Convert `forwardRef` component to custom hook (`useMyDialog`)
- [ ] Replace `useState(localData)` with `useRef` (for FormDialog) or function parameter (for CentralizedDialog)
- [ ] Replace `Dialog`/`WarningDialog` with `useFormDialog()` or `useCentralizedDialog()`
- [ ] Implement `handleSubmit` returning `Promise<DialogResult>` (for FormDialog)
- [ ] Handle form reset and cleanup in `.then()` callback (for FormDialog)
- [ ] Remove old exports (`forwardRef`, `DialogRef` interface, `displayName`)
- [ ] Update parent components (replace ref with hook, remove JSX rendering)
- [ ] Move any component props to open function data

### Phase 3: Verification

- [ ] Type check passes (`npx tsc --noEmit`)
- [ ] Lint passes (`pnpm lint`)
