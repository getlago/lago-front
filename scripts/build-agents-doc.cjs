#!/usr/bin/env node

/**
 * Script to build AGENTS.md from individual markdown files in docs/agents/
 *
 * Usage: node scripts/build-agents-doc.cjs
 */

const fs = require('fs');
const path = require('path');

const DOCS_DIR = path.join(__dirname, '..', 'docs', 'agents');
const OUTPUT_FILE = path.join(__dirname, '..', 'AGENTS.md');

function buildAgentsDoc() {
  console.log('Building AGENTS.md from docs/agents/...');

  // Read all .md files from docs/agents/ directory (excluding README.md)
  const files = fs.readdirSync(DOCS_DIR)
    .filter((file) => file.endsWith('.md') && file !== 'README.md')
    .sort(); // Sort alphabetically (works well with numbered prefixes)

  if (files.length === 0) {
    console.error('Error: No markdown files found in docs/agents/');
    process.exit(1);
  }

  console.log(`Found ${files.length} markdown file(s): ${files.join(', ')}`);

  const header = `<!--
  ⚠️ WARNING: This file is automatically generated!

  Do not edit this file manually.
  All changes must be made in the .md files in the docs/agents/ folder
  After making changes, run: pnpm run build:agents
-->

# Lago Billing System - Development Assistant

You are an expert development assistant for the Lago billing system project. Always follow these critical guidelines:
`;

  const sections = [header];

  for (const filename of files) {
    const filePath = path.join(DOCS_DIR, filename);

    if (!fs.existsSync(filePath)) {
      console.warn(`Warning: File ${filename} not found, skipping...`);
      continue;
    }

    const content = fs.readFileSync(filePath, 'utf-8');
    sections.push(content);
  }

  const fullContent = sections.join('\n');

  fs.writeFileSync(OUTPUT_FILE, fullContent, 'utf-8');
  console.log(`✅ Successfully built AGENTS.md (${fullContent.length} characters)`);
}

if (require.main === module) {
  buildAgentsDoc();
}

module.exports = { buildAgentsDoc };
